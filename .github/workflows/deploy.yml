name: Deploy Discord Bot to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Alibaba VPS
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          set -e

          echo "=========================================="
          echo "üöÄ Deploying Discord Bot to VPS"
          echo "=========================================="

          # Define variables
          DEPLOY_PATH="/var/www/discord-bot"
          REPO_URL="https://github.com/${{ github.repository }}.git"
          PM2_APP_NAME="thomas-bot"

          # Create deploy directory if not exists
          if [ ! -d "$DEPLOY_PATH" ]; then
            echo "üìÅ Creating deploy directory..."
            mkdir -p $DEPLOY_PATH
          fi

          cd $DEPLOY_PATH

          # Clone or pull repository
          if [ -d ".git" ]; then
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          else
            echo "üì• Cloning repository..."
            git clone $REPO_URL .
          fi

          # Install/Update dependencies
          echo "üì¶ Installing dependencies..."
          npm install --production

          # Create/Update .env file
          echo "‚öôÔ∏è Updating environment variables..."
          cat > .env << 'EOF'
          DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
          CLIENT_ID=${{ secrets.CLIENT_ID }}
          PUBLIC_KEY=${{ secrets.PUBLIC_KEY }}
          NODE_ENV=production
          PORT=8080
          EOF

          # Check if PM2 process exists
          if pm2 describe $PM2_APP_NAME > /dev/null 2>&1; then
            echo "üîÑ Restarting bot with PM2..."
            pm2 restart $PM2_APP_NAME --update-env
          else
            echo "üöÄ Starting bot with PM2..."
            pm2 start index.js --name $PM2_APP_NAME
            pm2 save
          fi

          # Show status
          echo ""
          echo "=========================================="
          echo "‚úÖ Deployment Complete!"
          echo "=========================================="
          pm2 status

    - name: Show Bot Logs
      if: always()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          echo "üìã Recent bot logs:"
          pm2 logs thomas-bot --lines 30 --nostream || echo "‚ö†Ô∏è No logs yet"
