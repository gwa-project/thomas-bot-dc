name: Deploy Golang Bot to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy Golang Bot
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Build binary
      run: |
        rm -f go.sum
        go mod tidy
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o thomas-bot .

    - name: Deploy to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        source: "thomas-bot,thomas-bot-dc/application.yml"
        target: "/tmp/"

    - name: Setup and Start Bot
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          set -e

          echo "=========================================="
          echo "ðŸš€ Deploying Golang Discord Bot"
          echo "=========================================="

          # Stop old Node.js bot if exists
          if pm2 describe thomas-bot > /dev/null 2>&1; then
            echo "â¹ Stopping old Node.js bot..."
            pm2 delete thomas-bot
            pm2 save
          fi

          # Clean old Node.js files
          if [ -d "/var/www/discord-bot" ]; then
            echo "ðŸ—‘ï¸ Removing old Node.js bot files..."
            rm -rf /var/www/discord-bot
          fi

          # Create new directory for Golang bot
          DEPLOY_PATH="/var/www/thomas-bot"
          mkdir -p $DEPLOY_PATH

          # Move binary
          echo "ðŸ“¦ Moving binary..."
          mv /tmp/thomas-bot $DEPLOY_PATH/
          chmod +x $DEPLOY_PATH/thomas-bot

          # Install Java for Lavalink
          if ! command -v java &> /dev/null; then
            echo "â˜• Installing Java 17..."
            apt-get update
            apt-get install -y openjdk-17-jre-headless
          fi

          # Install ffmpeg
          if ! command -v ffmpeg &> /dev/null; then
            echo "ðŸ“¥ Installing ffmpeg..."
            apt-get install -y ffmpeg
          fi

          # Setup Lavalink
          LAVALINK_PATH="/var/www/lavalink"
          mkdir -p $LAVALINK_PATH

          if [ ! -f "$LAVALINK_PATH/Lavalink.jar" ]; then
            echo "ðŸŽµ Downloading Lavalink..."
            wget -q https://github.com/lavalink-devs/Lavalink/releases/download/4.0.8/Lavalink.jar -O $LAVALINK_PATH/Lavalink.jar
          fi

          echo "ðŸ“ Moving Lavalink config..."
          mv /tmp/thomas-bot-dc/application.yml $LAVALINK_PATH/

          # Create .env file
          cd $DEPLOY_PATH
          cat > .env << 'EOF'
          DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
          CLIENT_ID=${{ secrets.CLIENT_ID }}
          PUBLIC_KEY=${{ secrets.PUBLIC_KEY }}
          PORT=8080
          EOF

          # Create Lavalink systemd service
          cat > /etc/systemd/system/lavalink.service << 'LAVALINK_EOF'
          [Unit]
          Description=Lavalink Music Server
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory=/var/www/lavalink
          ExecStart=/usr/bin/java -Xms64M -Xmx128M -jar Lavalink.jar
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          LAVALINK_EOF

          # Create bot systemd service
          cat > /etc/systemd/system/thomas-bot.service << 'SYSTEMD_EOF'
          [Unit]
          Description=Thomas Discord Bot (Golang)
          After=network.target lavalink.service
          Requires=lavalink.service

          [Service]
          Type=simple
          User=root
          WorkingDirectory=/var/www/thomas-bot
          ExecStart=/var/www/thomas-bot/thomas-bot
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          SYSTEMD_EOF

          # Reload systemd and start services
          echo "ðŸ”„ Starting services..."
          systemctl daemon-reload

          echo "ðŸŽµ Starting Lavalink..."
          systemctl enable lavalink
          systemctl restart lavalink

          sleep 5

          echo "ðŸ¤– Starting bot..."
          systemctl enable thomas-bot
          systemctl restart thomas-bot

          # Show status
          sleep 2
          echo ""
          echo "=========================================="
          echo "âœ… Deployment Complete!"
          echo "=========================================="
          echo ""
          echo "ðŸŽµ Lavalink Status:"
          systemctl status lavalink --no-pager -l | head -20
          echo ""
          echo "ðŸ¤– Bot Status:"
          systemctl status thomas-bot --no-pager -l | head -20

    - name: Show Bot Logs
      if: always()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          echo "ðŸ“‹ Recent bot logs:"
          journalctl -u thomas-bot -n 30 --no-pager || echo "âš ï¸ No logs yet"
